<html>
<head>
    <meta name=viewport content="width=device-width, initial-scale=1, user-scalable=0, viewport-fit=cover">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>kiwoom</title>
<style>
    li{
        margin-right: 10px;
    }
.edit-box { 
	display: block;
}


</style>
</head>
<body>

    <div class="addbox">
        <div class="btn-back-arrow" onclick="Page.back()"></div>
        <div>내 정보 수정</div>
        <div class="btn-text" onclick="upload()">저장</div>
    </div>
    <div class="page-body">
        <div class="vframe-3">
            <div class="user-info-pane-title">기본 정보</div>
            <div class="section"><div class="section pad-20 bg-white">

                <div class="edit-box">
                    <div class="icon gender hide"></div>
                    <div class="text">성별</div>
                    <select id="--gender">
                        <option value="none" style="color:#999">성별을 선택해주세요.</option>
                        <option value="m">남성</option>
                        <option value="f">여성</option>
                    </select>
                </div>

                <div class="edit-box">
                    <div class="icon name hide"></div>
                    <div class="text">이름</div>
                    <input id="--name" type="text" placeholder="이름 (닉네임)">
                    <div class="icon pen hide" onclick="setFocus('#--name')"></div>
                </div>

                <div class="edit-box ">
                    <div class="text">연령대</div>
                    <div style="display: flex;">
                        <div class="checks">
                            <input type="radio" id="age1" name="age">
                            <label for="age1">10대</label>
                        </div>
                        <div class="checks">
                            <input type="radio" id="age2" name="age">
                            <label for="age2">20대</label>
                        </div>
                        <div class="checks">
                            <input type="radio" id="age3" name="age">
                            <label for="age3">30대</label>
                        </div>
                        <div class="checks">
                            <input type="radio" id="age4" name="age">
                            <label for="age4">40대</label>
                        </div>
                        <div class="checks">
                            <input type="radio" id="age5" name="age">
                            <label for="age5">50대</label>
                        </div>
                        <div class="checks">
                            <input type="radio" id="age6" name="age">
                            <label for="age6">60대</label>
                        </div>
                    </div>

                </div>

            </div></div>

            <div class="user-info-pane-title" style="margin-top: 32px;">연락처 정보</div>
            <div class="section"><div class="section pad-25 bg-white">
                <div class="edit-box ">
                    <div class="icon phone hide"></div>
                    <div class="text">핸드폰</div>
                    <input id="--tel" type="text" placeholder="휴대폰 번호">
                    <div class="icon pen hide" onclick="setFocus('#--tel')"></div>
                </div>
                <div class="edit-box">
                    <div class="icon email hide"></div>
                    <div class="text">이메일</div>
                    <input id="--email" type="text" readonly>
                    <div class="icon pen hide" onclick="setFocus('#--email')"></div>
                </div>
                <div class="edit-box">
                    <div class="icon addr hide"></div>
                    <div class="text">주소</div>
                    <input id="--city" type="text" placeholder="----" readonly onclick="setAddr()">
                    <div class="icon pen hide" onclick="setAddr()"></div>
                </div>
                <div class="business-addr edit-box hide bdtop bdbot">
                    <div class="text">우편주소</div>
                    <input id="--city_" class="input user" type="text" placeholder="----" readonly onclick="setAddr_()">
                    <div class="icon pen hide" onclick="setAddr_()"> </div>
                </div>
            </div>
        </div>

        </div>
    </div>
</body>
</html>

<script src="../js/jquery-3.5.1.min.js"></script>
<script src="../js/core.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    Page.init("userInfo.html", init);
});
</script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap.bundle.js"></script>
<script src="../js/velocity.min.js"></script>
<script src="../js/addr.js"></script>
<script>
var pagectx = {};
function init(params) {
    pagectx = params;
    AJAX.call("jsp/userGet.jsp", {mid: pagectx.usrobj.mid}, function(data) {
        pagectx.usrobj = JSON.parse(data.trim());
        setPage(pagectx.usrobj);
    });

}

function setPage(usrobj) {
    console.log(usrobj);

    // ImageUploader.init("--file-photo", "--photo", cbOpenFace);
    
    // if (usrobj.image != null) {
    //     var imgurl = Config.getUserImgUrl(usrobj.mid, usrobj.image);
    //     $("#--photo").css("background-image", "url('../" + imgurl + "')");
    // }

    if (usrobj.gender != null) {
        $("#--gender").val(usrobj.gender).prop("selected", true);
    }
    if (usrobj.intro != null) $("#--intro").val(usrobj.intro);

    //keyword
    if (isValid(usrobj.keyword)) {
        var keyword = usrobj.keyword.split(" ");
        var str = "";
        for(var i=0; i<keyword.length; i++) {
            var k = keyword[i];
            if(k.trim() != "")
            str += getTagCode(k.replace(/#/g, ""));
        }
        $(".hash-list").html(str);
        // $("#--hashtag").val(usrobj.keyword);
    }



    if (usrobj.name != null) $("#--name").val(usrobj.name);
    if (usrobj.age != null) {
        $(`input[id=${usrobj.age}]`).click()
    }
    if (usrobj.tel != null) $("#--tel").val(usrobj.tel);

    $("#--email").val(usrobj.mid);

    if(usrobj.postcode != null){
        $("#--city_").val(usrobj.postname)
    }
    if(usrobj.type != undefined){
        $("#--name").attr("readonly", true)
    }

    // address setting ------------------------------------------    
    if (usrobj.addrobj != null) {
        var city = AddrKo.getCityName(usrobj.addrobj.code);
        if (city == null) return;
        
        $("#--city").val(city + " " + usrobj.addrobj.street);
    }


    Page.setHandler();
}

function setFocus(view) {
    $(view).focus();
    $(view).addClass("bdr-bot");
}

function setAddr() {
    if (!checkInput()) return;
    save(function() {
        Page.go("userAddr.html");
    });
}

function openImage() {
    ImageUploader.open("--file-photo", "--photo", cbOpenFace);
}

function cbOpenFace(file) {
    pagectx.image = file;
    save();
}

function save(cbfunc) {

    var usrobj = getObj();
    console.log(usrobj);
    
    var params = new FormData();
    params.append("mid", usrobj.mid);
    params.append("usrobj", JSON.stringify(usrobj));
    
    if (isValid(pagectx.image)) {
        params = ImageUploader.appendParams(params, "image", pagectx.image);
    }

    AJAX.call("jsp/userInfo.jsp", params, function(data) {
        if (cbfunc != null) cbfunc();
    }, true);
}

function upload() {
    if (!checkInput()) return;
    
    save(function() {
        Dialog.alert("프로필 업데이트가 완료되었습니다.", function() {
            //Page.back();
            //프로필 편집 후 세션 초기화 (작성된 글 변경이 늦음) by Moon 0315
            sessionStorage.clear();
            //주소 변경 후 프로필 업데이트 시 다시 주소 창으로 가는 것을 막음 by Moon 0307
            Page.go("main.html");
        });
    });
}

function checkInput() {
    var intro = $("#--intro").val().trim();
    if (intro == "") {
        Dialog.alert("프로필 소개를 입력해 주세요.", function() { $("#--intro").focus() });
        return false;
    };
    // var keyword = $("#--keyword").val().trim();
    var keyword = $(".hash-list").text();
    if (keyword == "") {
        Dialog.alert("관심 키워드를 입력해 주세요.", function() { $("#--keyword").focus() });
        return false;
    };
    if(pagectx.usrobj.type != "A"){
        var gender = $("#--gender").val();
        if (gender == "none") {
            Dialog.alert("성별을 선택해주세요.", function() { $("#--gender").focus() });
            return false;

            if($('input[name="age"]:checked')[0] == undefined){
                Dialog.alert("연령대를 선택해주세요.");
                return false;
            }
        };


        var tel = $("#--tel").val().trim();
        if (tel == "") {
            Dialog.alert("휴대폰 정보를 입력해 주세요.", function() { $("#--tel").focus() });
            return false;
        };

        if (!PhoneNum.check(tel)) {
            Dialog.alert("휴대폰 번호를 양식에 맞게 입력해 주세요. (예. 010-xxxx-xxxx)", function() { $("#--tel").focus() });
            return false;
        };
    }

    var name = $("#--name").val().trim();
    if (name == "") {
        Dialog.alert("이름(닉네임)을 입력해 주세요.", function() { $("#--name").focus() });
        return false;
    };

    var city = $("#--city").val().trim();
    if (city == "") {
        Dialog.confirm("주소 입력이 필요합니다. 주소 입력을 위한 페이지로 이동하시겠습니까?", function() {
            save(function() {
                Page.go("userAddr.html");
            });
        });
        return false;
    };


    var city = $("#--city").val().trim();
    if (city == "") {
        Dialog.confirm("주소 입력이 필요합니다. 주소 입력을 위한 페이지로 이동하시겠습니까?", function() { 
            save(function() {
	        	Page.go("userAddr.html");
            });
        });
        return false;
    }
    
    return true;
}

function getObj() {
    var intro = $("#--intro").val();

    var name = $("#--name").val().trim();

    if(pagectx.usrobj.type != "A"){
        var age = $('input[name="age"]:checked')[0].id
        var gender = $("#--gender").val();
    }

    // var street = $("#--street").val().trim();

    var usrobj = pagectx.usrobj;
    console.log(usrobj)

    var keyword = ""; // $("#--hashtag").val().trim();
    $(".hash-list li").each(function(idx, el) {
        keyword += $(this).text() + " ";
    });
    usrobj.keyword = keyword;

    usrobj.intro = intro;
    usrobj.name = name;
    // usrobj.street = street;
    if(usrobj.type != "A"){
        usrobj.age = age;
        usrobj.gender= gender;
        var tel = $("#--tel").val().trim();
        if (tel != "") usrobj.tel = tel;
    }

    if (pagectx.usrobj.image != null) { // keep the existing image file info
        usrobj.image = pagectx.usrobj.image;
    };


    if (pagectx.usrobj.addrobj != null) { // keep the existing user address info
        usrobj.addrobj = pagectx.usrobj.addrobj;
    };

    return usrobj;
};

function setAddr_() {
    if (!checkInput()) return;
    save(function() {
        Page.go("businessAddr.html");
    });
};

function addKeyword(evt, vid) {
    var str = $(vid).val();
    let last_ = str.substr(str.length-1, 1);
    if(evt.keyCode == 32 || last_ == " ") {
        var value = $(vid).val().trim();
        if(value == ""){
            return;
        }
        console.log(value)
        var ul_list = $(".hash-list");

        ul_list.append(this.getTagCode(value));
        $(vid).val("");
    }
}

function getTagCode(value) {
    var id = Math.random().toString(36).substr(2, 11);
    var str = "";
    str += "<li id='--"+id+"'>"
    str += "<div>#" + value + "</div>";
    str += "<div class='icon area' onclick='removeTag(\"--"+id+"\")'></div>";
    str += "</li>";
    return str;
}
function removeTag(id) {
    $("#"+id).remove();
}
</script>
